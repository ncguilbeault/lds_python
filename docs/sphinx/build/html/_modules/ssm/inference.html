<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ssm.inference &mdash; Linear Dynamical Systems  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Linear Dynamical Systems
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Demo scripts</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Linear Dynamical Systems</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ssm.inference</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ssm.inference</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="OnlineKalmanFilter"><a class="viewcode-back" href="../../ssm.html#ssm.inference.OnlineKalmanFilter">[docs]</a><span class="k">class</span> <span class="nc">OnlineKalmanFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class implementing the online Kalman filter algorithm for the following</span>
<span class="sd">    linear dynamical system:</span>

<span class="sd">    .. math::</span>
<span class="sd">       x_n &amp;= B\ x_{n-1} + w_n,\ \\textrm{where}\ w_n\sim\mathcal{N}(w_n|0, Q)\, \\textrm{and}\ x_n\in\Re^M</span>

<span class="sd">       y_n &amp;= Z\ x_{n-1} + v_n,\ \\textrm{where}\ v_n\sim\mathcal{N}(v_n|0, R)\, \\textrm{and}\ y_n\in\Re^N</span>

<span class="sd">       x_0&amp;\in\mathcal{N}(x_0|m_0, V_0)</span>

<span class="sd">    Example use:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        online_kf = OnlineKalmanFilter(B, Q, m0, V0, Z, R)</span>
<span class="sd">        x_pred, P_pred = online_kf.predict()</span>

<span class="sd">        for y in ys:</span>
<span class="sd">            x_filt, P_filt = online_kf.update(y)</span>
<span class="sd">            x_pred, P_pred = online_kf.predict()</span>

<span class="sd">    A script using `OnlineKalmanFilter` for tracking the position of a mouse</span>
<span class="sd">    can be found `here</span>
<span class="sd">    &lt;https://github.com/joacorapela/lds_python/blob/master/code/scripts/doOnlineFilterFWGMouseTrajectory.py&gt;`_</span>

<span class="sd">    Note 1:</span>
<span class="sd">        invocation so `predict()` and `update(y)` should alternate. That is,</span>
<span class="sd">        each invocation to `update(y)` should be preceded by an invocation to</span>
<span class="sd">        `predict()`, and each invocation to `predict()` (except the first one)</span>
<span class="sd">        should be preceded by an invoation to `update(y)`.</span>

<span class="sd">    Note 2:</span>
<span class="sd">        observations :math:`y_n` should be sampled uniformly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_B</span> <span class="o">=</span> <span class="n">B</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Q</span> <span class="o">=</span> <span class="n">Q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m0</span> <span class="o">=</span> <span class="n">m0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_V0</span> <span class="o">=</span> <span class="n">V0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Z</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_R</span> <span class="o">=</span> <span class="n">R</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">m0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_P</span> <span class="o">=</span> <span class="n">V0</span>

        <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

<div class="viewcode-block" id="OnlineKalmanFilter.predict"><a class="viewcode-back" href="../../ssm.html#ssm.inference.OnlineKalmanFilter.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predicts the next state.</span>

<span class="sd">        :return: (state, covariance): tuple containing the predicted state vector and covariance matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span></div>

<div class="viewcode-block" id="OnlineKalmanFilter.update"><a class="viewcode-back" href="../../ssm.html#ssm.inference.OnlineKalmanFilter.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the current state and covariance.</span>

<span class="sd">        :param y: observation :math:`\in\Re^M`</span>
<span class="sd">        :return: (state, covariance): tuple containing the updated state vector and covariance matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">pred_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">pred_obs</span>
            <span class="n">Stmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>
            <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">Sinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">residual</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">B</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B</span>

    <span class="nd">@B</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">B</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_B</span> <span class="o">=</span> <span class="n">B</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q</span>

    <span class="nd">@Q</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">Q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Q</span> <span class="o">=</span> <span class="n">Q</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">m0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_m0</span>

    <span class="nd">@m0</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">m0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m0</span> <span class="o">=</span> <span class="n">m0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">V0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_V0</span>

    <span class="nd">@V0</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">V0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_V0</span> <span class="o">=</span> <span class="n">V0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Z</span>

    <span class="nd">@Z</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">Z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Z</span> <span class="o">=</span> <span class="n">Z</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">R</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R</span>

    <span class="nd">@R</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">R</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_R</span> <span class="o">=</span> <span class="n">R</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span>

    <span class="nd">@x</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">P</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P</span>

    <span class="nd">@P</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">P</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_P</span> <span class="o">=</span> <span class="n">P</span></div>


<div class="viewcode-block" id="TimeVaryingOnlineKalmanFilter"><a class="viewcode-back" href="../../ssm.html#ssm.inference.TimeVaryingOnlineKalmanFilter">[docs]</a><span class="k">class</span> <span class="nc">TimeVaryingOnlineKalmanFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class implementing the time-varying and online Kalman filter algorithm for the following</span>
<span class="sd">    linear dynamical system:</span>

<span class="sd">    .. math::</span>
<span class="sd">       x_n &amp;= B_n\ x_{n-1} + w_n,\ \\textrm{where}\ w_n\sim\mathcal{N}(w_n|0, Q_n)\, \\textrm{and}\ x_n\in\Re^M</span>

<span class="sd">       y_n &amp;= Z_n\ x_{n-1} + v_n,\ \\textrm{where}\ v_n\sim\mathcal{N}(v_n|0, R_n)\, \\textrm{and}\ y_n\in\Re^N</span>

<span class="sd">       x_0&amp;\in\mathcal{N}(x_0|m_0, V_0)</span>

<span class="sd">    Example use:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        online_kf = OnlineKalmanFilter(m0, V0)</span>
<span class="sd">        x_pred, P_pred = online_kf.predict()</span>

<span class="sd">        for y in ys:</span>
<span class="sd">            x_filt, P_filt = online_kf.update(y)</span>
<span class="sd">            x_pred, P_pred = online_kf.predict()</span>

<span class="sd">    A script using `OnlineKalmanFilter` for tracking the position of a mouse</span>
<span class="sd">    can be found `here</span>
<span class="sd">    &lt;https://github.com/joacorapela/lds_python/blob/master/code/scripts/doOnlineFilterFWGMouseTrajectory.py&gt;`_</span>

<span class="sd">    Note 1:</span>
<span class="sd">        invocation so `predict()` and `update(y)` should alternate. That is,</span>
<span class="sd">        each invocation to `update(y)` should be preceded by an invocation to</span>
<span class="sd">        `predict()`, and each invocation to `predict()` (except the first one)</span>
<span class="sd">        should be preceded by an invoation to `update(y)`.</span>

<span class="sd">    Note 2:</span>
<span class="sd">        observations :math:`y_n` should be sampled uniformly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="TimeVaryingOnlineKalmanFilter.predict"><a class="viewcode-back" href="../../ssm.html#ssm.inference.TimeVaryingOnlineKalmanFilter.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predicts the next state.</span>

<span class="sd">        :return: (state, covariance): tuple containing the predicted state vector and covariance matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">x</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span></div>

<div class="viewcode-block" id="TimeVaryingOnlineKalmanFilter.update"><a class="viewcode-back" href="../../ssm.html#ssm.inference.TimeVaryingOnlineKalmanFilter.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the current state and covariance.</span>

<span class="sd">        :param y: observation :math:`\in\Re^M`</span>
<span class="sd">        :return: (state, covariance): tuple containing the updated state vector and covariance matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if y.ndim == 1:</span>
        <span class="c1">#     y = np.expand_dims(y, axis=1)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="n">pred_obs</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">x</span>
            <span class="n">innovation</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">pred_obs</span>
            <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>
            <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">Sinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innovation</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Z</span><span class="p">)</span> <span class="o">@</span> <span class="n">P</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">P</span></div></div>


<div class="viewcode-block" id="filterLDS_SS_withMissingValues_torch"><a class="viewcode-back" href="../../ssm.html#ssm.inference.filterLDS_SS_withMissingValues_torch">[docs]</a><span class="k">def</span> <span class="nf">filterLDS_SS_withMissingValues_torch</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Kalman filter implementation of the algorithm described in Shumway and</span>
<span class="sd">    Stoffer 2006.</span>

<span class="sd">    :param: y: time series to be smoothed</span>
<span class="sd">    :type: y: numpy array (NxT)</span>

<span class="sd">    :param: B: state transition matrix</span>
<span class="sd">    :type: B: numpy matrix (MxM)</span>

<span class="sd">    :param: Q: state noise covariance matrix</span>
<span class="sd">    :type: Q: numpy matrix (MxM)</span>

<span class="sd">    :param: m0: initial state mean</span>
<span class="sd">    :type: m0: one-dimensional numpy array (M)</span>

<span class="sd">    :param: V0: initial state covariance</span>
<span class="sd">    :type: V0: numpy matrix (MxM)</span>

<span class="sd">    :param: Z: state to observation matrix</span>
<span class="sd">    :type: Z: numpy matrix (NxM)</span>

<span class="sd">    :param: R: observations covariance matrix</span>
<span class="sd">    :type: R: numpy matrix (NxN)</span>

<span class="sd">    :return:  {xnn1, Pnn1, xnn, Pnn, innov, K, Sn, logLike}: xnn1 and Pnn1 (predicted means, MxT, and covariances, MxMxT), xnn and Pnn (filtered means, MxT, and covariances, MxMxT), innov (innovations, NxT), K (Kalman gain matrices, MxNxT), Sn (innovations covariance matrices, NxNxT), logLike (data loglikelihood, float).</span>
<span class="sd">    :rtype: dictionary</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">torch</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The first or last observation cannot contain nan&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">m0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mean must be 1 dimensional&quot;</span><span class="p">)</span>

    <span class="c1"># N: number of observations</span>
    <span class="c1"># M: dim state space</span>
    <span class="c1"># P: dim observations</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xnn1_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">Pnn1_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">xnn_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">Pnn_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">innov_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">Sn_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="c1"># k==0</span>
    <span class="n">xnn1</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">m0</span>
    <span class="n">Pnn1</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">V0</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
    <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>
    <span class="n">Sn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Stmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">Sinv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
    <span class="n">innov</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Z</span> <span class="o">@</span>  <span class="n">xnn1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innov</span>
    <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span>
    <span class="n">logLike</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">*</span><span class="n">P</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">logdet</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span> <span class="o">-</span> \
        <span class="n">innov</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span> <span class="o">@</span> <span class="n">innov</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logLike</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;obtained nan log likelihood&quot;</span><span class="p">)</span>

    <span class="n">xnn1_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">xnn1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Pnn1_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn1</span>
    <span class="n">xnn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">xnn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Pnn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn</span>
    <span class="n">innov_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">innov</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Sn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sn</span>

    <span class="c1"># k&gt;1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">xnn1</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">xnn</span>
        <span class="n">Pnn1</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">Pnn</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="k">if</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]))):</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>
            <span class="n">Sn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">Sinv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
            <span class="n">innov</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Z</span> <span class="o">@</span> <span class="n">xnn1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innov</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span>
        <span class="n">logLike</span> <span class="o">=</span> <span class="n">logLike</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">logdet</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span> <span class="o">-</span>\
            <span class="n">innov</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span> <span class="o">@</span> <span class="n">innov</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logLike</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;obtained nan log likelihood&quot;</span><span class="p">)</span>
        <span class="n">xnn1_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">xnn1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Pnn1_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn1</span>
        <span class="n">xnn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">xnn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Pnn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn</span>
        <span class="n">innov_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">innov</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Sn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sn</span>
    <span class="n">logLike</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">logLike</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xnn1&quot;</span><span class="p">:</span> <span class="n">xnn1_h</span><span class="p">,</span> <span class="s2">&quot;Pnn1&quot;</span><span class="p">:</span> <span class="n">Pnn1_h</span><span class="p">,</span> <span class="s2">&quot;xnn&quot;</span><span class="p">:</span> <span class="n">xnn_h</span><span class="p">,</span> <span class="s2">&quot;Pnn&quot;</span><span class="p">:</span> <span class="n">Pnn_h</span><span class="p">,</span>
              <span class="s2">&quot;innov&quot;</span><span class="p">:</span> <span class="n">innov_h</span><span class="p">,</span> <span class="s2">&quot;KN&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="s2">&quot;Sn&quot;</span><span class="p">:</span> <span class="n">Sn_h</span><span class="p">,</span> <span class="s2">&quot;logLike&quot;</span><span class="p">:</span> <span class="n">logLike</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">answer</span></div>


<div class="viewcode-block" id="logLikeLDS_withMissingValues_torch"><a class="viewcode-back" href="../../ssm.html#ssm.inference.logLikeLDS_withMissingValues_torch">[docs]</a><span class="k">def</span> <span class="nf">logLikeLDS_withMissingValues_torch</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Kalman filter implementation of the algorithm described in Shumway and</span>
<span class="sd">    Stoffer 2006.</span>

<span class="sd">    N: dimensionality of observations</span>

<span class="sd">    M: dimnensionality of state</span>

<span class="sd">    T: number of observations</span>

<span class="sd">    :param: y: time series to be smoothed</span>
<span class="sd">    :type: y: numpy array (NxT)</span>

<span class="sd">    :param: B: state transition matrix</span>
<span class="sd">    :type: B: numpy matrix (MxM)</span>

<span class="sd">    :param: Q: state noise covariance matrix</span>
<span class="sd">    :type: Q: numpy matrix (MxM)</span>

<span class="sd">    :param: m0: initial state mean</span>
<span class="sd">    :type: m0: one-dimensional numpy array (M)</span>

<span class="sd">    :param: V0: initial state covariance</span>
<span class="sd">    :type: V0: numpy matrix (MxM)</span>

<span class="sd">    :param: Z: state to observation matrix</span>
<span class="sd">    :type: Z: numpy matrix (NxM)</span>

<span class="sd">    :param: R: observations covariance matrix</span>
<span class="sd">    :type: R: numpy matrix (NxN)</span>

<span class="sd">    :return:  logLike (data loglikelihood, float).</span>
<span class="sd">    :rtype: dictionary</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">torch</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The first or last observation cannot contain nan&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">m0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mean must be 1 dimensional&quot;</span><span class="p">)</span>

    <span class="c1"># T: number of observations</span>
    <span class="c1"># M: dim state space</span>
    <span class="c1"># P: dim observations</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xnn</span> <span class="o">=</span> <span class="n">m0</span>
    <span class="n">Pnn</span> <span class="o">=</span> <span class="n">V0</span>
    <span class="n">logLike</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">log2Pi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">xnn1</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">xnn</span>
        <span class="n">Pnn1</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">Pnn</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="c1"># print(Pnn1)</span>
        <span class="c1"># Pnn1.register_hook(print)  # This will print the gradient when it&#39;s computed.</span>

        <span class="k">if</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]))):</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>
            <span class="n">Sn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">Sinv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
            <span class="n">innov</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Z</span> <span class="o">@</span> <span class="n">xnn1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innov</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span>
        <span class="n">logLike</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">log2Pi</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">logdet</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">innov</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sn</span><span class="p">,</span> <span class="n">innov</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logLike</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;obtained nan log likelihood&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logLike</span></div>


<div class="viewcode-block" id="lds_forecast"><a class="viewcode-back" href="../../ssm.html#ssm.inference.lds_forecast">[docs]</a><span class="k">def</span> <span class="nf">lds_forecast</span><span class="p">(</span><span class="n">xnn</span><span class="p">,</span> <span class="n">Pnn</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forecasts the mean and covariance of a Kalman filter state at horizon h.</span>

<span class="sd">    Args:</span>
<span class="sd">        xnn (numpy array or torch tensor): Filtered state mean at time n, shape (state_dim,)</span>
<span class="sd">        Pnn (numpy array or torch tensor): Filtered state covariance at time n, shape (state_dim, state_dim)</span>
<span class="sd">        B (numpy or torch matrix): State transition matrix, shape (state_dim, state_dim)</span>
<span class="sd">        Q (numpy or torch matrix): Process noise covariance matrix, shape (state_dim, state_dim)</span>
<span class="sd">        h (int): Forecast horizon</span>

<span class="sd">    Returns:</span>
<span class="sd">        x_pred (Tensor): Forecasted mean at time n+h</span>
<span class="sd">        P_pred (Tensor): Forecasted covariance at time n+h</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_pred</span> <span class="o">=</span> <span class="n">xnn</span>
    <span class="n">P_pred</span> <span class="o">=</span> <span class="n">Pnn</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="n">P_pred</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">P_pred</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="n">x_pred</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">x_pred</span>

    <span class="k">return</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">P_pred</span></div>


<div class="viewcode-block" id="lds_forecast_batch"><a class="viewcode-back" href="../../ssm.html#ssm.inference.lds_forecast_batch">[docs]</a><span class="k">def</span> <span class="nf">lds_forecast_batch</span><span class="p">(</span><span class="n">xnn</span><span class="p">,</span> <span class="n">Pnn</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">	Forecasts the mean and covariance of a batch of Kalman filter states at horizon h. The first forecasted sample corresponds to sample time h-1 and the last forecasted sample correspond to sample time N+h-1; thus this function return N+1 samples.</span>

<span class="sd">    :param: xnn: filtered state mean at time n</span>
<span class="sd">    :type: xnn: numpy array or torch tensor, shape (state_dim,)</span>

<span class="sd">    :param: Pnn: filtered state covariance at time n</span>
<span class="sd">    :type: Pnn: numpy array or torch tensor, shape (state_dim, state_dim)</span>

<span class="sd">    :param: B: state transition matrix</span>
<span class="sd">    :type: B: numpy or torch matrix, shape (state_dim, state_dim)</span>

<span class="sd">    :param: Q: process noise covariance matrix</span>
<span class="sd">    :type: Q: numpy or torch matrix, shape (state_dim, state_dim)</span>

<span class="sd">    :param: h: forecast horizon</span>
<span class="sd">    :type: h: int</span>

<span class="sd">    :return:  (x_pred, P_pred): tuple containing the forecasted mean and covariance at time n+h</span>
<span class="sd">    :rtype: tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">xnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">xnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">P_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Pnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Pnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m0</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">V0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">lds_forecast</span><span class="p">(</span>
            <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">xnn</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">Pnn</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xnn</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">lds_forecast</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">xnn</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">Pnn</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">P_pred</span></div>


<div class="viewcode-block" id="log_like_observations_given_forecasts_lds"><a class="viewcode-back" href="../../ssm.html#ssm.inference.log_like_observations_given_forecasts_lds">[docs]</a><span class="k">def</span> <span class="nf">log_like_observations_given_forecasts_lds</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">P_pred</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="n">first_forecasted_sample</span> <span class="o">=</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># align measurements and forecasts</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">first_forecasted_sample</span><span class="p">:]</span>
    <span class="n">x_pred</span> <span class="o">=</span> <span class="n">x_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">T</span><span class="o">-</span><span class="n">first_forecasted_sample</span><span class="p">)]</span>
    <span class="n">P_pred</span> <span class="o">=</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">T</span><span class="o">-</span><span class="n">first_forecasted_sample</span><span class="p">)]</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># compute log likelihood</span>
    <span class="n">N_log_2pi</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">log_like</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">num_terms</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="n">n</span><span class="p">])):</span>
            <span class="k">continue</span>
        <span class="n">yn_pred</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
        <span class="n">innov</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">yn_pred</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>
        <span class="n">mahal</span> <span class="o">=</span> <span class="n">innov</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">innov</span><span class="p">)</span>
        <span class="n">sign</span><span class="p">,</span> <span class="n">log_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;S is not positive definite&quot;</span><span class="p">)</span>
        <span class="n">log_like</span> <span class="o">+=</span> <span class="n">N_log_2pi</span> <span class="o">+</span> <span class="n">log_det</span> <span class="o">+</span> <span class="n">mahal</span>
        <span class="n">num_terms</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">log_like</span> <span class="o">/=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_terms</span>
    <span class="k">return</span> <span class="n">log_like</span></div>


<div class="viewcode-block" id="log_like_observations_given_forecasts_ekf"><a class="viewcode-back" href="../../ssm.html#ssm.inference.log_like_observations_given_forecasts_ekf">[docs]</a><span class="k">def</span> <span class="nf">log_like_observations_given_forecasts_ekf</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">P_pred</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Zdot</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
    <span class="n">first_forecasted_sample</span> <span class="o">=</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># align measurements and forecasts</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">first_forecasted_sample</span><span class="p">:]</span>
    <span class="n">x_pred</span> <span class="o">=</span> <span class="n">x_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">T</span><span class="o">-</span><span class="n">first_forecasted_sample</span><span class="p">)]</span>
    <span class="n">P_pred</span> <span class="o">=</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">T</span><span class="o">-</span><span class="n">first_forecasted_sample</span><span class="p">)]</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># compute log likelihood</span>
    <span class="n">N_log_2pi</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">log_like</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">num_terms</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="n">n</span><span class="p">])):</span>
            <span class="k">continue</span>
        <span class="n">yn_pred</span> <span class="o">=</span> <span class="n">Z</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">S_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">Zdot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span> <span class="o">@</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">@</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">innov_n</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">yn_pred</span>
        <span class="n">mahal_n</span> <span class="o">=</span> <span class="n">innov_n</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">S_n</span><span class="p">,</span> <span class="n">innov_n</span><span class="p">)</span>
        <span class="n">sign_n</span><span class="p">,</span> <span class="n">log_det_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">S_n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign_n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;S is not positive definite&quot;</span><span class="p">)</span>
        <span class="n">log_like</span> <span class="o">+=</span> <span class="n">N_log_2pi</span> <span class="o">+</span> <span class="n">log_det_n</span> <span class="o">+</span> <span class="n">mahal_n</span>
        <span class="n">num_terms</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">log_like</span> <span class="o">/=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num_terms</span>
    <span class="k">return</span> <span class="n">log_like</span></div>


<div class="viewcode-block" id="ekf_forecast"><a class="viewcode-back" href="../../ssm.html#ssm.inference.ekf_forecast">[docs]</a><span class="k">def</span> <span class="nf">ekf_forecast</span><span class="p">(</span><span class="n">xnn</span><span class="p">,</span> <span class="n">Pnn</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Bdot</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forecasts the mean and covariance of an EKF filter state at horizon h.</span>

<span class="sd">    N: dimensionality of observations</span>

<span class="sd">    M: dimnensionality of state</span>

<span class="sd">    T: number of observations</span>

<span class="sd">    :param: xnn: filtered state mean at time n</span>
<span class="sd">    :type: xnn: :math:`\Re^{N\\times 1\\times T}`</span>

<span class="sd">    :param: Pnn: filtered state covariance at time n</span>
<span class="sd">    :type: Pnn: :math:`\Re^{N\\times N\\times T}`</span>

<span class="sd">    :param: B: state transition function</span>
<span class="sd">    :type: B: :math:`\Re^M\\rightarrow\Re^M`</span>

<span class="sd">    :param: Bdot: Jacobian of state transition function</span>
<span class="sd">    :type: Bdot: :math:`\Re^M\\rightarrow\Re^{M\\times M}`</span>

<span class="sd">    :param: Q: state noise covariance function</span>
<span class="sd">    :type: Q: :math:`\Re^M\\rightarrow\Re^{M\\times M}`</span>

<span class="sd">    :param: h: forecasting horizon</span>
<span class="sd">    :type: h: int</span>

<span class="sd">    :return:  (x_pred, P_pred): tuple containing the forecasted mean and covariance at time n+h</span>
<span class="sd">    :rtype: tuple</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_pred</span> <span class="o">=</span> <span class="n">xnn</span>
    <span class="n">P_pred</span> <span class="o">=</span> <span class="n">Pnn</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="n">P_pred</span> <span class="o">=</span> <span class="n">Bdot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span> <span class="o">@</span> <span class="n">P_pred</span> <span class="o">@</span> <span class="n">Bdot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>
        <span class="n">x_pred</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">P_pred</span></div>


<div class="viewcode-block" id="ekf_forecast_batch"><a class="viewcode-back" href="../../ssm.html#ssm.inference.ekf_forecast_batch">[docs]</a><span class="k">def</span> <span class="nf">ekf_forecast_batch</span><span class="p">(</span><span class="n">xnn</span><span class="p">,</span> <span class="n">Pnn</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Bdot</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">xnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">xnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">P_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Pnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Pnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m0</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">V0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ekf_forecast</span><span class="p">(</span>
            <span class="n">xnn</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">Pnn</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">Bdot</span><span class="o">=</span><span class="n">Bdot</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xnn</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">x_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">P_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">ekf_forecast</span><span class="p">(</span>
        <span class="n">xnn</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">Pnn</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">Bdot</span><span class="o">=</span><span class="n">Bdot</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">P_pred</span></div>


<div class="viewcode-block" id="filterEKF_withMissingValues_torch"><a class="viewcode-back" href="../../ssm.html#ssm.inference.filterEKF_withMissingValues_torch">[docs]</a><span class="k">def</span> <span class="nf">filterEKF_withMissingValues_torch</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Bdot</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Zdot</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span>
                                      <span class="n">Sn_reg</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Extended Kalman filter implementation of the algorithm described in</span>
<span class="sd">    Chapter 10 of Durbin and Koopman 2012.</span>

<span class="sd">    N: dimensionality of observations</span>

<span class="sd">    M: dimnensionality of state</span>

<span class="sd">    T: number of observations</span>

<span class="sd">    :param: y: time series to be smoothed</span>
<span class="sd">    :type: y: :math:`\Re^{N\\times T}`</span>

<span class="sd">    :param: B: state transition function</span>
<span class="sd">    :type: B: :math:`\Re^M\\rightarrow\Re^M`</span>

<span class="sd">    :param: Bdot: Jacobian of state transition function</span>
<span class="sd">    :type: Bdot: :math:`\Re^M\\rightarrow\Re^{M\\times M}`</span>

<span class="sd">    :param: Q: state noise covariance function</span>
<span class="sd">    :type: Q: :math:`\Re^M\\rightarrow\Re^{M\\times M}`</span>

<span class="sd">    :param: m0: initial state mean</span>
<span class="sd">    :type: m0: :math:`\Re^{M}`</span>

<span class="sd">    :param: V0: initial state covariance</span>
<span class="sd">    :type: V0: :math:`\Re^{M\\times M}`</span>

<span class="sd">    :param: Z: state to observation function</span>
<span class="sd">    :type: Z: :math:`\Re^M\\rightarrow\Re^N`</span>

<span class="sd">    :param: Zdot: Jacobian of state to observation function</span>
<span class="sd">    :type: Zdot: :math:`\Re^M\\rightarrow\Re^{N\\times M}`</span>

<span class="sd">    :param: R: observations covariance function</span>
<span class="sd">    :type: R: :math:`\Re^M\\rightarrow\Re^{N\\times N}`</span>

<span class="sd">    :return:  {xnn1, Pnn1, xnn, Pnn, innov, K, Sn, logLike}: xnn1 and Pnn1 (predicted means, MxT, and covariances, MxMxT), xnn and Pnn (filtered means, MxT, and covariances, MxMxT), innov (innovations, NxT), K (Kalman gain matrices, MxNxT), Sn (innovations covariance matrices, NxNxT), logLike (data loglikelihood, float).</span>
<span class="sd">    :rtype: dictionary</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">torch</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The first or last observation cannot contain nan&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">m0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mean must be 1 dimensional&quot;</span><span class="p">)</span>

    <span class="c1"># T: number of observations</span>
    <span class="c1"># M: dim state space</span>
    <span class="c1"># N: dim observations</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">m0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xnn1_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">Pnn1_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">xnn_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">Pnn_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">innov_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">Sn_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">xnn</span> <span class="o">=</span> <span class="n">m0</span>
    <span class="n">Pnn</span> <span class="o">=</span> <span class="n">V0</span>
    <span class="n">logLike</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">log2Pi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">xnn1</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span>
        <span class="n">Pnn1</span> <span class="o">=</span> <span class="n">Bdot</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span> <span class="o">@</span> <span class="n">Pnn</span> <span class="o">@</span> <span class="n">Bdot</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]))):</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span> <span class="o">@</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span>
            <span class="n">Sn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Sn_reg</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">Sinv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
            <span class="n">innov</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innov</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span> <span class="o">@</span> <span class="n">Pnn1</span>
        <span class="n">logLike</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">log2Pi</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">logdet</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">innov</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sn</span><span class="p">,</span> <span class="n">innov</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logLike</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;obtained nan log likelihood&quot;</span><span class="p">)</span>
        <span class="n">xnn1_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">xnn1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Pnn1_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn1</span>
        <span class="n">xnn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">xnn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Pnn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn</span>
        <span class="n">innov_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">innov</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Sn_h</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sn</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xnn1&quot;</span><span class="p">:</span> <span class="n">xnn1_h</span><span class="p">,</span> <span class="s2">&quot;Pnn1&quot;</span><span class="p">:</span> <span class="n">Pnn1_h</span><span class="p">,</span> <span class="s2">&quot;xnn&quot;</span><span class="p">:</span> <span class="n">xnn_h</span><span class="p">,</span> <span class="s2">&quot;Pnn&quot;</span><span class="p">:</span> <span class="n">Pnn_h</span><span class="p">,</span>
              <span class="s2">&quot;innov&quot;</span><span class="p">:</span> <span class="n">innov_h</span><span class="p">,</span> <span class="s2">&quot;KN&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="s2">&quot;Sn&quot;</span><span class="p">:</span> <span class="n">Sn_h</span><span class="p">,</span> <span class="s2">&quot;logLike&quot;</span><span class="p">:</span> <span class="n">logLike</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">answer</span></div>


<div class="viewcode-block" id="logLikeEKF_withMissingValues_torch"><a class="viewcode-back" href="../../ssm.html#ssm.inference.logLikeEKF_withMissingValues_torch">[docs]</a><span class="k">def</span> <span class="nf">logLikeEKF_withMissingValues_torch</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Bdot</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Zdot</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span>
                                       <span class="n">Sn_reg</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calculation of the log-likelihood for the extended Kalman filter model.</span>

<span class="sd">    N: dimensionality of observations</span>

<span class="sd">    M: dimnensionality of state</span>

<span class="sd">    T: number of observations</span>

<span class="sd">    :param: y: time series to be smoothed</span>
<span class="sd">    :type: y: :math:`\Re^{N\\times T}`</span>

<span class="sd">    :param: B: state transition function</span>
<span class="sd">    :type: B: :math:`\Re^M\\rightarrow\Re^M`</span>

<span class="sd">    :param: Bdot: Jacobian of state transition function</span>
<span class="sd">    :type: Bdot: :math:`\Re^M\\rightarrow\Re^{M\\times M}`</span>

<span class="sd">    :param: Q: state noise covariance function</span>
<span class="sd">    :type: Q: :math:`\Re^M\\rightarrow\Re^{M\\times M}`</span>

<span class="sd">    :param: m0: initial state mean</span>
<span class="sd">    :type: m0: :math:`\Re^{M}`</span>

<span class="sd">    :param: V0: initial state covariance</span>
<span class="sd">    :type: V0: :math:`\Re^{M\\times M}`</span>

<span class="sd">    :param: Z: state to observation function</span>
<span class="sd">    :type: Z: :math:`\Re^M\\rightarrow\Re^N`</span>

<span class="sd">    :param: Zdot: Jacobian of state to observation function</span>
<span class="sd">    :type: Zdot: :math:`\Re^M\\rightarrow\Re^{N\\times M}`</span>

<span class="sd">    :param: R: observations covariance function</span>
<span class="sd">    :type: R: :math:`\Re^M\\rightarrow\Re^{N\\times N}`</span>

<span class="sd">    :return:  {xnn1, Pnn1, xnn, Pnn, innov, K, Sn, logLike}: xnn1 and Pnn1 (predicted means, MxT, and covariances, MxMxT), xnn and Pnn (filtered means, MxT, and covariances, MxMxT), innov (innovations, NxT), K (Kalman gain matrices, MxNxT), Sn (innovations covariance matrices, NxNxT), logLike (data loglikelihood, float).</span>
<span class="sd">    :rtype: dictionary</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">torch</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The first or last observation cannot contain nan&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">m0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mean must be 1 dimensional&quot;</span><span class="p">)</span>

    <span class="c1"># T: number of observations</span>
    <span class="c1"># M: dim state space</span>
    <span class="c1"># N: dim observations</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">m0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xnn</span> <span class="o">=</span> <span class="n">m0</span>
    <span class="n">Pnn</span> <span class="o">=</span> <span class="n">V0</span>
    <span class="n">logLike</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">log2Pi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">xnn1</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span>
        <span class="n">Pnn1</span> <span class="o">=</span> <span class="n">Bdot</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span> <span class="o">@</span> <span class="n">Pnn</span> <span class="o">@</span> <span class="n">Bdot</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span><span class="p">(</span><span class="n">xnn</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]))):</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span> <span class="o">@</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span>
            <span class="n">Sn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Sn_reg</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">Sinv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">@</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
            <span class="n">innov</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span>
            <span class="n">xnn</span> <span class="o">=</span> <span class="n">xnn1</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innov</span>
            <span class="n">Pnn</span> <span class="o">=</span> <span class="n">Pnn1</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Zdot</span><span class="p">(</span><span class="n">xnn1</span><span class="p">)</span> <span class="o">@</span> <span class="n">Pnn1</span>
        <span class="n">logLike</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">log2Pi</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">logdet</span><span class="p">(</span><span class="n">Sn</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">innov</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sn</span><span class="p">,</span> <span class="n">innov</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logLike</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;obtained nan log likelihood&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logLike</span></div>


<div class="viewcode-block" id="filterLDS_SS_withMissingValues_np"><a class="viewcode-back" href="../../ssm.html#ssm.inference.filterLDS_SS_withMissingValues_np">[docs]</a><span class="k">def</span> <span class="nf">filterLDS_SS_withMissingValues_np</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Kalman filter implementation of the algorithm described in Shumway and</span>
<span class="sd">    Stoffer 2006.</span>

<span class="sd">    :param: y: time series to be smoothed</span>
<span class="sd">    :type: y: numpy array (NxT)</span>

<span class="sd">    :param: B: state transition matrix</span>
<span class="sd">    :type: B: numpy matrix (MxM)</span>

<span class="sd">    :param: Q: state noise covariance matrix</span>
<span class="sd">    :type: Q: numpy matrix (MxM)</span>

<span class="sd">    :param: m0: initial state mean</span>
<span class="sd">    :type: m0: one-dimensional numpy array (M)</span>

<span class="sd">    :param: V0: initial state covariance</span>
<span class="sd">    :type: V0: numpy matrix (MxM)</span>

<span class="sd">    :param: Z: state to observation matrix</span>
<span class="sd">    :type: Z: numpy matrix (NxM)</span>

<span class="sd">    :param: R: observations covariance matrix</span>
<span class="sd">    :type: R: numpy matrix (NxN)</span>

<span class="sd">    :return:  {xnn1, Pnn1, xnn, Pnn, innov, K, Sn, logLike}: xnn1 and Pnn1 (predicted means, MxT, and covariances, MxMxT), xnn and Pnn (filtered means, MxT, and covariances, MxMxT), innov (innovations, NxT), K (Kalman gain matrices, MxNxT), Sn (innovations covariance matrices, NxNxT), logLike (data loglikelihood, float).</span>
<span class="sd">    :rtype: dictionary</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">m0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mean must be 1 dimensional&quot;</span><span class="p">)</span>

    <span class="c1"># N: number of observations</span>
    <span class="c1"># M: dim state space</span>
    <span class="c1"># P: dim observations</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xnn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">Pnn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">xnn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">Pnn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">innov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">Sn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>

    <span class="c1"># k==0</span>
    <span class="n">xnn1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">m0</span>
    <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">V0</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
    <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>
    <span class="n">Sn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">Sinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Sn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
    <span class="n">innov</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Z</span> <span class="o">@</span>  <span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">xnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innov</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">logLike</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">*</span><span class="n">P</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">Sn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> \
        <span class="n">innov</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span> <span class="o">@</span> <span class="n">innov</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># k&gt;1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">xnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span> <span class="o">@</span> <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]))):</span>
            <span class="n">xnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Stmp</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">R</span>
            <span class="n">Sn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Stmp</span> <span class="o">+</span> <span class="n">Stmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">Sinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Sn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span>
            <span class="n">innov</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Z</span> <span class="o">@</span> <span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">xnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">innov</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">logLike</span> <span class="o">=</span> <span class="n">logLike</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">Sn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>\
            <span class="n">innov</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span> <span class="o">@</span> <span class="n">innov</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">logLike</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">logLike</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xnn1&quot;</span><span class="p">:</span> <span class="n">xnn1</span><span class="p">,</span> <span class="s2">&quot;Pnn1&quot;</span><span class="p">:</span> <span class="n">Pnn1</span><span class="p">,</span> <span class="s2">&quot;xnn&quot;</span><span class="p">:</span> <span class="n">xnn</span><span class="p">,</span> <span class="s2">&quot;Pnn&quot;</span><span class="p">:</span> <span class="n">Pnn</span><span class="p">,</span>
              <span class="s2">&quot;innov&quot;</span><span class="p">:</span> <span class="n">innov</span><span class="p">,</span> <span class="s2">&quot;KN&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="s2">&quot;Sn&quot;</span><span class="p">:</span> <span class="n">Sn</span><span class="p">,</span> <span class="s2">&quot;logLike&quot;</span><span class="p">:</span> <span class="n">logLike</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">answer</span></div>


<div class="viewcode-block" id="smoothLDS_SS"><a class="viewcode-back" href="../../ssm.html#ssm.inference.smoothLDS_SS">[docs]</a><span class="k">def</span> <span class="nf">smoothLDS_SS</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">xnn</span><span class="p">,</span> <span class="n">Pnn</span><span class="p">,</span> <span class="n">xnn1</span><span class="p">,</span> <span class="n">Pnn1</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">V0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Kalman smoother implementation</span>

<span class="sd">    :param: B: state transition matrix</span>
<span class="sd">    :type: B: numpy matrix (MxM)</span>

<span class="sd">    :param: xnn: filtered means (from Kalman filter)</span>
<span class="sd">    :type: xnn: numpy array (MxT)</span>

<span class="sd">    :param: Pnn: filtered covariances (from Kalman filter)</span>
<span class="sd">    :type: Pnn: numpy array (MxMXT)</span>

<span class="sd">    :param: xnn1: predicted means (from Kalman filter)</span>
<span class="sd">    :type: xnn1: numpy array (MxT)</span>

<span class="sd">    :param: Pnn1: predicted covariances (from Kalman filter)</span>
<span class="sd">    :type: Pnn1: numpy array (MxMXT)</span>

<span class="sd">    :param: m0: initial state mean</span>
<span class="sd">    :type: m0: one-dimensional numpy array (M)</span>

<span class="sd">    :param: V0: initial state covariance</span>
<span class="sd">    :type: V0: numpy matrix (MxM)</span>

<span class="sd">    :return:  {xnN, PnN, Jn, x0N, V0N, J0}: xnn1 and Pnn1 (smoothed means, MxT, and covariances, MxMxT), Jn (smoothing gain matrix, MxMxT), x0N and V0N (smoothed initial state mean, M, and covariance, MxM), J0 (initial smoothing gain matrix, MxN).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">m0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mean must be 1 dimensional&quot;</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">xnn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xnN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">PnN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="n">Jn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>

    <span class="n">xnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">PnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
        <span class="n">Jn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">xnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">Jn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">xnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span><span class="o">-</span><span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">PnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pnn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">Jn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">PnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">]</span><span class="o">-</span><span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">])</span> <span class="o">@</span> <span class="n">Jn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># initial state x00 and V00</span>
    <span class="c1"># return the smooth estimates of the state at time 0: x0N and V0N</span>
    <span class="n">J0</span> <span class="o">=</span> <span class="n">V0</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">x0N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">J0</span> <span class="o">@</span> <span class="p">(</span><span class="n">xnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">V0N</span> <span class="o">=</span> <span class="n">V0</span> <span class="o">+</span> <span class="n">J0</span> <span class="o">@</span> <span class="p">(</span><span class="n">PnN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Pnn1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">@</span> <span class="n">J0</span><span class="o">.</span><span class="n">T</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xnN&quot;</span><span class="p">:</span> <span class="n">xnN</span><span class="p">,</span> <span class="s2">&quot;PnN&quot;</span><span class="p">:</span> <span class="n">PnN</span><span class="p">,</span> <span class="s2">&quot;Jn&quot;</span><span class="p">:</span> <span class="n">Jn</span><span class="p">,</span> <span class="s2">&quot;x0N&quot;</span><span class="p">:</span> <span class="n">x0N</span><span class="p">,</span> <span class="s2">&quot;V0N&quot;</span><span class="p">:</span> <span class="n">V0N</span><span class="p">,</span>
              <span class="s2">&quot;J0&quot;</span><span class="p">:</span> <span class="n">J0</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">answer</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Joaquin Rapela.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>