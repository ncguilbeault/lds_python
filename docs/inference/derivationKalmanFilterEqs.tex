\begin{theorem}
	\label{thm:kalmanFilterEqs}

    Given the linear dynamical systems model given in
    Section~\ref{sec:ldsModel} then the means and covariances of the prediction
    (Eq.~\ref{eq:prediction}) and filtering (Eq.~\ref{eq:filtering})
    distributions are calculated iteratively as follows:

    \begin{alignat}{2}
        \mathbf{x}_{0|0}&=\mathbf{m}_0&&\text{init filtered mean}\label{eq:x0G0}\\
        P_{0|0}&=V_0&&\text{init filtered covariance}\label{eq:P0G0}\\
        \mathbf{x}_{n|n-1}&=A_{n-1}\mathbf{x}_{n-1|n-1}&&\text{prediction mean}\label{eq:xtGtm1}\\
        P_{n|n-1}&=A_{n-1}P_{n-1|n-1}A_{n-1}^\intercal+Q_{n-1}&&\text{prediction covariance}\label{eq:PtGtm1}\\
        \hat{\mathbf{y}}_{n|n-1}&\triangleq E\{\mathbf{y}_n|\mathbf{y}_1,\ldots,\mathbf{y}_{n-1}\}=B_n\mathbf{x}_{n|n-1}&&\text{predicted observation}\label{eq:ytGtm1}\\
        \mathbf{z}_n&\triangleq\mathbf{y}_n-\hat{\mathbf{y}}_{n|n-1}&&\text{residual}\nonumber\\
        S_n&\triangleq \text{Cov}\{\mathbf{z}_n|\mathbf{y}_1,\ldots,\mathbf{y}_{n-1}\}=B_nP_{n|n-1}B_n^\intercal+R_n\quad&&\text{residual covariance}\label{eq:St}\\
        \mathbf{K}_n&=P_{n|n-1}B_n^\intercal S_n^{-1}&&\text{Kalman gain}\label{eq:Kt}\\
        \mathbf{x}_{n|n}&=\mathbf{x}_{n|n-1}+K_n\mathbf{z}_n&&\text{filtering mean}\label{eq:xtGt}\\
        \mathbf{P}_{n|n}&=(I-K_nB_n)P_{n|n-1}&&\text{filtering covariance}\label{eq:PtGt}
    \end{alignat}

\end{theorem}

The following proof adds details to that given in Section 4.3.1 of
\citet{durbinAndKoopman12}.

\begin{proof}
    Call $Y_n=\{\mathbf{y}_1,\ldots,\mathbf{y}_n\}$, then

    \begin{align}
        \mathbf{x}_{n|n-1}&=E\{\mathbf{x}_n|Y_{n-1}\}=E\{A_{n-1}\mathbf{x}_{n-1}+\mathbf{w}_{n-1}|Y_{n-1}\}\nonumber\\
                          &=A_{n-1}E\{\mathbf{x}_{n-1}|Y_{n-1}\}+E\{\mathbf{w}_{n-1}|Y_{n-1}\}\nonumber\\
                          &=A_{n-1}\mathbf{x}_{n-1|n-1}+E\{\mathbf{w}_{n-1}\}\footnotemark[1]=A_{n-1}\mathbf{x}_{n-1|n-1}\nonumber
    \end{align}
    \footnotetext[1]{$\mathbf{w}_{n-1}$ is independent of $Y_{n-1}$.}
	This proves Eq.~\ref{eq:xtGtm1}.

    \begin{align}
        \mathbf{P}_{n|n-1}&=\text{Cov}\{\mathbf{x}_n|Y_{n-1}\}=E\{(\mathbf{x}_n-\mathbf{x}_{n|n-1})(\mathbf{x}_n-\mathbf{x}_{n|n-1})^\intercal|Y_{n-1}\}\nonumber\\
                          &=E\{\left(A_{n-1}\mathbf{x}_{n-1}+w_{n-1}-A_{n-1}\mathbf{x}_{n-1|n-1}\right)\left(A_{n-1}\mathbf{x}_{n-1}+w_{n-1}-A_{n-1}\mathbf{x}_{n-1|n-1}\right)^\intercal|Y_{n-1}\}\nonumber\\
                          &=E\{\left(A_{n-1}(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})+w_{n-1}\right)\left(A_{n-1}(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})+w_{n-1}\right)^\intercal|Y_{n-1}\}\nonumber\\
                          &=A_{n-1}E\{(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})^\intercal|Y_{n-1}\}A_{n-1}^\intercal+\nonumber\\
                          &\qquad E\{w_{n-1}(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})^\intercal|Y_{n-1}\}A_{n-1}^\intercal+\nonumber\\
                          &\qquad A_{n-1}E\{(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})w_{n-1}^\intercal|Y_{n-1}\}+\nonumber\\
                          &\qquad E\{w_{n-1}w_{n-1}^\intercal|Y_{n-1}\}\nonumber\\
                          &=A_{n-1}E\{(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})^\intercal|Y_{n-1}\}A_{n-1}^\intercal+\nonumber\\
                          &\qquad E\{w_{n-1}|Y_{n-1}\}E\{(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})^\intercal|Y_{n-1}\}A_{n-1}^\intercal\footnotemark[2]+\nonumber\\
                          &\qquad A_{n-1}E\{(\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1})|Y_{n-1}\}E\{w_{n-1}^\intercal|Y_{n-1}\}+\nonumber\\
                          &\qquad E\{w_{n-1}w_{n-1}^\intercal\}\nonumber\\
                          &=A_{n-1}P_{n-1|n-1}A_{n-1}^\intercal+Q_{n-1}\footnotemark[3]\nonumber
    \end{align}
    \footnotetext[2]{$\mathbf{w}_{n-1}$ is independent of $x_{n-1}$ given $Y_{n-1}$.}
    \footnotetext[3]{$E\{\mathbf{x}_{n-1}-\mathbf{x}_{n-1|n-1}|Y_{n-1}\}=E\{\mathbf{x}_{n-1}|Y_{n-1}\}-\mathbf{x}_{n-1|n-1}=\mathbf{x}_{n-1|n-1}-\mathbf{x}_{n-1|n-1}=0$.}
	This proves Eq.~\ref{eq:PtGtm1}.

    \begin{align}
        \hat{\mathbf{y}}_{n|n-1}&=E\{\mathbf{y}_n|Y_{n-1}\}=E\{B_n\mathbf{x}_n+\mathbf{v}_n|Y_{n-1}\}=B_nE\{\mathbf{x}_n|Y_{n-1}\}+E\{\mathbf{v}_n|Y_{n-1}\}\nonumber\\
                                &=B_n\mathbf{x}_{n|n-1}+E\{\mathbf{v}_n\}=B_n\mathbf{x}_{n|n-1}\nonumber
    \end{align}
	This proves Eq.~\ref{eq:ytGtm1}.

    Because

    \begin{align}
        \mathbf{z}_n&=\mathbf{y}_n-\hat{\mathbf{y}}_{n|n-1}=B_n\mathbf{x}_n+\mathbf{v}_n-B_n\mathbf{x}_{n|n-1}=B_n(\mathbf{x}_n-\mathbf{x}_{n|n-1})+\mathbf{v}_n\label{eq:ztProof}
    \end{align}

    \noindent $Y_{n-1}$ and $\mathbf{z}_n$ are fixed if and only if $Y_n$ is
    fixed\footnotemark[4]. Then

    \footnotetext[4]{If we now $Y_{n-1}$ and $\mathbf{z}_n$, then we know
    $\hat{\mathbf{y}}_{n|n-1}$ and $\mathbf{z}_n$, then (by the first equality
    in Eq.~\ref{eq:ztProof}) we know $\mathbf{y}_n$, thus we know $Y_n$. Also, if we
    know $Y_n$, we know $\hat{\mathbf{y}}_{n|n-1}$ and $\mathbf{y}_n$ and (by
    the first equality in Eq.~\ref{eq:ztProof}) we know $\mathbf{z}_n$.}.

    \begin{align}
        \mathbf{x}_{n|n}&=E\{\mathbf{x}_n|Y_n\}=E\{\mathbf{x}_n|Y_{n-1},\mathbf{z}_n\}\footnotemark[5]\nonumber\\
                        &=E\{\mathbf{x}_n|Y_{n-1}\}+\text{Cov}\left(\mathbf{x}_n,\mathbf{z}_n|Y_{n-1}\right)\text{Cov}\left(\mathbf{z}_n|Y_{n-1}\right)^{-1}\mathbf{z}_n\footnotemark[6]\label{eq:xtGtTmp}\\
        \text{Cov}\left(\mathbf{x}_n,\mathbf{z}_n|Y_{n-1}\right)&=\text{Cov}\left(\mathbf{x}_n,B_n(\mathbf{x}_n-\mathbf{x}_{n|n-1})+\mathbf{v}_n|Y_{n-1}\right)\nonumber\\
                                                                &=E\{(\mathbf{x}_n-\mathbf{x}_{n|n-1})(B_n(\mathbf{x}_n-\mathbf{x}_{n|n-1})+\mathbf{v}_n)^\intercal|Y_{n-1}\}\nonumber\\
                                                                &=E\{(\mathbf{x}_n-\mathbf{x}_{n|n-1})(\mathbf{x}_n-\mathbf{x}_{n|n-1})^\intercal|Y_{n-1}\}B_n^\intercal\nonumber\\
                                                                &\qquad +E\{(\mathbf{x}_n-\mathbf{x}_{n|n-1})\mathbf{v}_n^\intercal|Y_{n-1}\}\nonumber\\
                                                                &=P_{n|n-1}B_n^\intercal\footnotemark[7]\label{eq:covXZ}\\
        S_n=\text{Cov}\left(\mathbf{z}_n|Y_{n-1}\right)&=E\{\mathbf{z}_n\mathbf{z}_n^\intercal|Y_{n-1}\}\nonumber\\
                                                       &=E\{\left(B_n(\mathbf{x}_n-\mathbf{x}_{n|n-1})+\mathbf{v}_n\right)\left(B_n(\mathbf{x}_n-\mathbf{x}_{n|n-1})+\mathbf{v}_n\right)^\intercal|Y_{n-1}\}\footnotemark[8]\nonumber\\
                                                       &=B_nE\{\left(\mathbf{x}_n-\mathbf{x}_{n|n-1}\right)\left(\mathbf{x}_n-\mathbf{x}_{n|n-1}\right)^\intercal|Y_{n-1}\}B_n^\intercal+B_nE\{\left(\mathbf{x}_n-\mathbf{x}_{n|n-1}\right)\mathbf{v}_n^\intercal|Y_{n-1}\}\nonumber\\
                                                       &\qquad +E\{\mathbf{v}_n\left(\mathbf{x}_n-\mathbf{x}_{n|n-1}\right)^\intercal\}B_n^\intercal+E\{\mathbf{v}_n\mathbf{v_n}^\intercal|Y_{n-1}\}\nonumber\\
                                                       &=B_nE\{\left(\mathbf{x}_n-\mathbf{x}_{n|n-1}\right)\left(\mathbf{x}_n-\mathbf{x}_{n|n-1}\right)^\intercal|Y_{n-1}\}B_n^\intercal+\nonumber\\
                                                       &\qquad +E\{\mathbf{v}_n\mathbf{v_n}^\intercal\}\footnotemark[7]\footnotemark[9]\nonumber\\
                                                       &=B_nP_{n|n-1}B_n^\intercal+R_n\label{eq:covZ}
    \end{align}
    \footnotetext[5]{The validity of the last equality follow from measure theory arguments (that I don't know).}
    \footnotetext[6]{Refer to Eq.~\ref{eq:conditionalMean} in Lemma~\ref{lemma:conditionalGaussians}.}
    \footnotetext[7]{$E\{(\mathbf{x}_n-\mathbf{x}_{n|n-1})\mathbf{v}_n^\intercal|Y_{n-1}\}=E\{\mathbf{x}_n-\mathbf{x}_{n|n-1}|Y_{n-1}\}E\{\mathbf{v}_n^\intercal|Y_{n-1}\}=(E\{\mathbf{x}_n|Y_{n-1}\}-\mathbf{x}_{n|n-1})E\{\mathbf{v}_n^\intercal|Y_{n-1}\}=(\mathbf{x}_{n|n-1}-\mathbf{x}_{n|n-1})E\{\mathbf{v}_n^\intercal|Y_{n-1}\}=0$
    because $\mathbf{x}_n$ is independent of $\mathbf{v}_n$ given $Y_{n-1}$.}
    \footnotetext[8]{Eq.~\ref{eq:ztProof}.}
    \footnotetext[9]{$\mathbf{v}_n$ is independent from $Y_{n-1}$.}

	This proves Eq.~\ref{eq:St}.

    Combining Eqs.~\ref{eq:xtGtTmp}, \ref{eq:covXZ} and~\ref{eq:covZ} we obtain

    \begin{align}
        \mathbf{x}_{n|n}&=\mathbf{x}_{n|n-1}+P_{n|n-1}B_n^\intercal
        S_n^{-1}\mathbf{z}_n\nonumber\\
                        &=\mathbf{x}_{n|n-1}+K_n\mathbf{z}_n\quad\text{with } K_n=P_{n|n-1}B_n^\intercal S_n^{-1}\nonumber\\
        P_{n|n}&=\text{Cov}(\mathbf{x}_n|Y_n)=\text{Cov}(\mathbf{x}_n|Y_{n-1},\mathbf{z}_n)=P_{n|n-1}-P_{n|n-1}B_n^\intercal
        S_n^{-1}B_nP_{n|n-1}\footnotemark[10]\nonumber\\
               &=\left(I-P_{n|n-1}B_n^\intercal S_n^{-1}B_n\right)P_{n|n-1}=\left(I-K_nB_n\right)P_{n|n-1}\nonumber
    \end{align}
    \footnotetext[10]{Refer to Eq.~\ref{eq:conditionalCov} in Lemma~\ref{lemma:conditionalGaussians} with $\mathbf{x}=\mathbf{x}_n|Y_{n-1}$ and $\mathbf{y}=\mathbf{z}_n|Y_{n-1}$ giving

		\begin{align*}
			\Sigma_{x|y}&=\Sigma_{\mathbf{x}_n|\mathbf{z}_n,Y_{n-1}}=\Sigma_{\mathbf{x}_n|Y_n}=P_{n|n}\\
			\Sigma_{xx}&=\Sigma_{\mathbf{x}_n|Y_{n-1}}=P_{n|n-1}\\
			\Sigma_{xy}&=\Sigma_{\mathbf{x}_n\mathbf{z}_n|Y_{n-1}}=\text{Cov}(\mathbf{x}_n,\mathbf{z}_n|Y_{n-1})=P_{n|n-1}B_n^\intercal\\
			\Sigma_{yy}&=\Sigma_{\mathbf{z}_n\mathbf{z}_n|Y_{n-1}}=\text{Cov}(\mathbf{z}_n|Y_{n-1})=S_n\\
                        &\text{thus}\\
            P_{n|n}&=P_{n|n-1}-P_{n|n-1}B_n^\intercal S_n^{-1}B_nP_{n|n-1}
		\end{align*}
    }
	This proves Eqs.~\ref{eq:Kt}, \ref{eq:xtGt} and~\ref{eq:PtGt}.

	Using Eqs.~\ref{eq:x0G0} and~\ref{eq:P0G0} in Eqs.~\ref{eq:xtGtm1} and~\ref{eq:PtGtm1} we obtain

    \begin{align*}
        \mathbf{x}_{1|0}&=A_0\mathbf{x}_{0|0}=A_0\mathbf{m}_0\\
        \mathbf{P}_{1|0}&=A_0P_{0|0}A_0^\intercal+Q_0=A_0V_0A_0^\intercal+Q_0
    \end{align*}

	If Eqs.~\ref{eq:x0G0} and~\ref{eq:P0G0} are correct, then the density of $\mathbf{x}_1$ should be $p(\mathbf{x}_1)=\mathcal{N}(\mathbf{x}_1|\mathbf{x}_{1|0},P_{1|0})$. We now calculate this density using the linear dynamical system model in Theorem~\ref{thm:kalmanFilterEqs}.

    \begin{align}
		p(\mathbf{x}_1)&=\int p(\mathbf{x}_1,\mathbf{x}_0)d\mathbf{x}_0=\int p(\mathbf{x}_1|\mathbf{x}_0)p(\mathbf{x}_0)d\mathbf{x}_0=\int\mathcal{N}(\mathbf{x}_1|A_0\mathbf{x}_0,Q_0)\mathcal{N}(\mathbf{x}_0|\mathbf{m}_0,V_0)d\mathbf{x}_0\nonumber\\
                       &=\mathcal{N}(\mathbf{x}_1|A_0\mathbf{m}_0,A_0V_0A_0^\intercal+Q_0)\footnotemark[11]=\mathcal{N}(\mathbf{x}_1|\mathbf{x}_{1|0},\mathbf{P}_{1|0})\nonumber
    \end{align}
    \footnotetext[11]{Lemma~\ref{lemma:linearModelGaussianLatents}.}
	This proves Eqs.~\ref{eq:x0G0} and~\ref{eq:P0G0}.

\end{proof}

\pagebreak

\input{conditionalDistForGaussianRVs}

\pagebreak

\input{marginalOfLinearGaussianModel}

\pagebreak

\input{inverseOfBlockMatrix}
